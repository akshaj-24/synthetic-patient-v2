<!DOCTYPE html>
<html>

{% load static %}

<head>
  <title>New Session</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .section-card { border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 24px; background: #fff; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .field-wrap { margin-bottom: 12px; }
    .field-row { display: flex; align-items: flex-start; gap: 8px; }
    .field-row .field-input { flex: 1; }
    .btn-gen { flex-shrink: 0; }
    .field-loading { background-color: #f8f9fa !important; color: #aaa; }
    textarea { resize: vertical; }
    .is-invalid-dep { border-color: #dc3545 !important; box-shadow: 0 0 0 0.2rem rgba(220,53,69,.15) !important; }

    /* Patient modal table */
    .patient-table th { cursor: pointer; user-select: none; white-space: nowrap; }
    .patient-table th:hover { background: #f0f0f0; }
    .sort-icon { font-size: 0.7rem; margin-left: 4px; color: #aaa; }
    .sort-icon.active { color: #000; }
    .modal-xl { max-width: 90vw; }
    #patientTable td { vertical-align: top; }

    /* Profile modal */
    .profile-label { font-size: 0.72rem; color: #6c757d; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; margin-bottom: 1px; }
    .profile-value { font-size: 0.93rem; margin-bottom: 10px; }
  </style>
</head>

<body class="bg-light">

{% include 'partials/navbar.html' %}
    
<div class="container py-5" style="max-width: 860px;">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-start mb-2">
    <div>
      <h3 class="mb-0">Create New Session</h3>
      <p class="text-muted mb-0">Patient Details</p>
    </div>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-dark" onclick="openPatientModal()">
        <i class="bi bi-folder2-open me-1"></i> Load Patient
      </button>
      <button type="button" class="btn btn-dark" onclick="autogenerateAll()">
        <i class="bi bi-stars me-1"></i> Autogenerate All
      </button>
    </div>
  </div>

  <!-- Hint text -->
    <p class="text-muted small mb-3">
  <i class="bi bi-info-circle me-1"></i>
  Fill in fields below and click <strong>Autogenerate</strong> to pass as instructions.
</p>

  <form method="post" id="newSessionForm" class="mt-4">
    {% csrf_token %}

    <!-- ── SECTION 1: Identity ── -->
    <div class="section-card">
      <div class="section-header">
        <h5 class="mb-0"><i class="bi bi-person-vcard me-2"></i>Identity</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="autogenerateSection('identity')">
          <i class="bi bi-stars me-1"></i> Autogenerate Section
        </button>
      </div>

      <div class="row g-2">
        <div class="col-md-6">
          <div class="field-wrap">
            <label class="form-label small text-muted">Age</label>
            <div class="field-row">
              <div class="field-input"><input type="number" id="age" name="age" class="form-control" placeholder="18-80" min="18" max="80"></div>
              <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('age', getDeps('age'))"><i class="bi bi-shuffle"></i></button>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="field-wrap">
            <label class="form-label small text-muted">Gender</label>
            <div class="field-row">
              <div class="field-input">
                <select id="gender" name="gender" class="form-select">
                  <option value="">Select gender</option>
                  <option>Male</option>
                  <option>Female</option>
                  <option>Non-binary</option>
                  <option>Transgender</option>
                </select>
              </div>
              <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('gender', getDeps('gender'))"><i class="bi bi-shuffle"></i></button>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="field-wrap">
            <label class="form-label small text-muted">Ethnicity</label>
            <div class="field-row">
              <div class="field-input">
                <select id="ethnicity" name="ethnicity" class="form-select">
                  <option value="">Select ethnicity</option>
                  <option>White / Caucasian</option>
                  <option>Black / African American</option>
                  <option>Hispanic / Latino</option>
                  <option>East Asian</option>
                  <option>South Asian</option>
                  <option>Southeast Asian</option>
                  <option>Middle Eastern</option>
                  <option>Indigenous / First Nations</option>
                  <option>Mixed / Multiracial</option>
                  <option>Prefer not to say</option>
                </select>
              </div>
              <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('ethnicity', getDeps('ethnicity'))"><i class="bi bi-shuffle"></i></button>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="field-wrap">
            <label class="form-label small text-muted">Marital Status</label>
            <div class="field-row">
              <div class="field-input">
                <select id="marital_status" name="marital_status" class="form-select">
                  <option value="">Select marital status</option>
                  <option>Single</option>
                  <option>Relationship</option>
                  <option>Common-Law</option>
                  <option>Married</option>
                  <option>Divorced</option>
                  <option>Widowed</option>
                  <option>Separated</option>
                </select>
              </div>
              <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('marital_status', getDeps('marital_status'))"><i class="bi bi-shuffle"></i></button>
            </div>
          </div>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Name</label>
        <div class="field-row">
          <div class="field-input"><input type="text" id="name" name="name" class="form-control" placeholder="Patient Name"></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('name', getDeps('name'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Education</label>
        <div class="field-row">
          <div class="field-input"><input type="text" id="education" name="education" class="form-control" placeholder="Education Level"></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('education', getDeps('education'))"><i class="bi bi-shuffle"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Occupation</label>
        <div class="field-row">
          <div class="field-input"><input type="text" id="occupation" name="occupation" class="form-control" placeholder="Occupation"></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('occupation', getDeps('occupation'))"><i class="bi bi-shuffle"></i></button>
        </div>
      </div>
    </div>

    <!-- ── SECTION 2: Clinical Profile ── -->
    <div class="section-card">
      <div class="section-header">
        <h5 class="mb-0"><i class="bi bi-clipboard2-pulse me-2"></i>Clinical Profile</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="autogenerateSection('clinical')">
          <i class="bi bi-stars me-1"></i> Autogenerate Section
        </button>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Disorder</label>
        <div class="field-row">
          <div class="field-input">
            <select id="disorder" name="disorder" class="form-select">
              <option value="">Select disorder</option>
              <option value="MDD">Major Depressive Disorder (MDD)</option>
              <option value="GAD">Generalized Anxiety Disorder (GAD)</option>
              <option value="PPD">Paranoid Personality Disorder (PPD)</option>
            </select>
          </div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('disorder', getDeps('disorder'))"><i class="bi bi-shuffle"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Patient Type <span class="text-muted fw-normal">(comma separated)</span></label>
        <div class="field-row">
          <div class="field-input"><input type="text" id="type" name="type" class="form-control" placeholder="e.g. anxious, avoidant, withdrawn"></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('type', getDeps('type'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Starting Emotions <span class="text-muted fw-normal">(comma separated)</span></label>
        <div class="field-row">
          <div class="field-input"><input type="text" id="base_emotions" name="base_emotions" class="form-control" placeholder="e.g. sadness, guilt, shame"></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('base_emotions', getDeps('base_emotions'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Intake</label>
        <div class="field-row">
          <div class="field-input"><textarea id="intake" name="intake" class="form-control" rows="2" placeholder="Intake summary"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('intake', getDeps('intake'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>
    </div>

    <!-- ── SECTION 3: CBT Cognitive Model ── -->
    <div class="section-card">
      <div class="section-header">
        <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Cognitive Model</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="autogenerateSection('cbt')">
          <i class="bi bi-stars me-1"></i> Autogenerate Section
        </button>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Helpless Beliefs <span class="text-muted fw-normal">(comma separated)</span></label>
        <div class="field-row">
          <div class="field-input"><input type="text" id="helpless_beliefs" name="helpless_beliefs" class="form-control" placeholder="e.g. I am powerless, Nothing I do matters"></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('helpless_beliefs', getDeps('helpless_beliefs'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Unlovable Beliefs <span class="text-muted fw-normal">(comma separated)</span></label>
        <div class="field-row">
          <div class="field-input"><input type="text" id="unlovable_beliefs" name="unlovable_beliefs" class="form-control" placeholder="e.g. I am unworthy of love"></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('unlovable_beliefs', getDeps('unlovable_beliefs'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Worthless Beliefs <span class="text-muted fw-normal">(comma separated)</span></label>
        <div class="field-row">
          <div class="field-input"><input type="text" id="worthless_beliefs" name="worthless_beliefs" class="form-control" placeholder="e.g. I am a failure"></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('worthless_beliefs', getDeps('worthless_beliefs'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Intermediate Belief</label>
        <div class="field-row">
          <div class="field-input"><textarea id="intermediate_belief" name="intermediate_belief" class="form-control" rows="2" placeholder="Rules, attitudes, assumptions"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('intermediate_belief', getDeps('intermediate_belief'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Trigger</label>
        <div class="field-row">
          <div class="field-input"><textarea id="trigger" name="trigger" class="form-control" rows="2" placeholder="Situations that activate core beliefs"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('trigger', getDeps('trigger'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Automatic Thoughts</label>
        <div class="field-row">
          <div class="field-input"><textarea id="auto_thoughts" name="auto_thoughts" class="form-control" rows="2" placeholder="Automatic thoughts in response to triggers"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('auto_thoughts', getDeps('auto_thoughts'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Coping Strategies</label>
        <div class="field-row">
          <div class="field-input"><textarea id="coping_strategies" name="coping_strategies" class="form-control" rows="2" placeholder="How the patient copes"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('coping_strategies', getDeps('coping_strategies'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Behavior</label>
        <div class="field-row">
          <div class="field-input"><textarea id="behavior" name="behavior" class="form-control" rows="2" placeholder="Observable behavioral patterns"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('behavior', getDeps('behavior'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>
    </div>

    <!-- ── SECTION 4: Background & History ── -->
    <div class="section-card">
      <div class="section-header">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Background & History</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="autogenerateSection('background')">
          <i class="bi bi-stars me-1"></i> Autogenerate Section
        </button>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Childhood History</label>
        <div class="field-row">
          <div class="field-input"><textarea id="childhood_history" name="childhood_history" class="form-control" rows="3" placeholder="Patient childhood events"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('childhood_history', getDeps('childhood_history'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Education History</label>
        <div class="field-row">
          <div class="field-input"><textarea id="education_history" name="education_history" class="form-control" rows="3" placeholder="Patient education history"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('education_history', getDeps('education_history'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Occupation History</label>
        <div class="field-row">
          <div class="field-input"><textarea id="occupation_history" name="occupation_history" class="form-control" rows="3" placeholder="Patient occupation history"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('occupation_history', getDeps('occupation_history'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Relationship History</label>
        <div class="field-row">
          <div class="field-input"><textarea id="relationship_history" name="relationship_history" class="form-control" rows="3" placeholder="Patient relationship history"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('relationship_history', getDeps('relationship_history'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Medical History</label>
        <div class="field-row">
          <div class="field-input"><textarea id="medical_history" name="medical_history" class="form-control" rows="3" placeholder="Patient medical history"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('medical_history', getDeps('medical_history'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Personal History</label>
        <div class="field-row">
          <div class="field-input"><textarea id="personal_history" name="personal_history" class="form-control" rows="3" placeholder="Patient personal history"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('personal_history', getDeps('personal_history'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Session History</label>
        <div class="field-row">
          <div class="field-input"><textarea id="session_history" name="session_history" class="form-control" rows="3" placeholder="Patient session history: If you want to simulate a follow up session please provide a brief summary of what you discussed previously OR instructions for auto generation. Blank auto-generation will assume no prior sessions."></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('session_history', getDeps('session_history'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Family Tree</label>
        <div class="field-row">
          <div class="field-input"><textarea id="family_tree" name="family_tree" class="form-control" rows="3" placeholder="Family structure and relationships"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('family_tree', getDeps('family_tree'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Timeline</label>
        <div class="field-row">
          <div class="field-input"><textarea id="timeline" name="timeline" class="form-control" rows="3" placeholder="Key life events in chronological order"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('timeline', getDeps('timeline'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>
    </div>

    <!-- ── SECTION 5: Narrative ── -->
    <div class="section-card">
      <div class="section-header">
        <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Narrative</h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="autogenerateSection('narrative')">
          <i class="bi bi-stars me-1"></i> Autogenerate Section
        </button>
      </div>

      <div class="field-wrap">
        <label class="form-label small text-muted">Vignette</label>
        <div class="field-row">
          <div class="field-input"><textarea id="vignette" name="vignette" class="form-control" rows="4" placeholder="Short narrative vignette describing the patient, may include key events, emotions, and behaviors"></textarea></div>
          <button type="button" class="btn btn-outline-secondary btn-gen" onclick="generateField('vignette', getDeps('vignette'))"><i class="bi bi-stars"></i></button>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="d-flex justify-content-between mb-5">
      <a href="/" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Cancel
      </a>
      <button type="submit" class="btn btn-dark px-5">
        <i class="bi bi-play-fill me-1"></i> Start Session
      </button>
    </div>
  </form>
</div>

<!-- ════════════════ PATIENT LIST MODAL ════════════════ -->
<div class="modal fade" id="patientModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-people me-2"></i>Select Patient</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

        <!-- Search + filter row -->
        <div class="d-flex gap-2 mb-3">
          <input type="text" id="patientSearch" class="form-control" placeholder="Search by name, disorder, occupation, gender...">
          <div class="form-check form-switch d-flex align-items-center gap-2 ms-2 text-nowrap">
            <input class="form-check-input" type="checkbox" id="myPatientsToggle" onchange="toggleMyPatients()">
            <label class="form-check-label" for="myPatientsToggle">My Patients</label>
          </div>
        </div>

        <table class="table table-hover patient-table" id="patientTable">
          <thead class="table-light">
            <tr>
              <th onclick="sortTable('name')">Name <i class="bi bi-arrow-down-up sort-icon" id="sort-name"></i></th>
              <th onclick="sortTable('age')">Age <i class="bi bi-arrow-down-up sort-icon" id="sort-age"></i></th>
              <th onclick="sortTable('gender')">Gender <i class="bi bi-arrow-down-up sort-icon" id="sort-gender"></i></th>
              <th onclick="sortTable('disorder')">Disorder <i class="bi bi-arrow-down-up sort-icon" id="sort-disorder"></i></th>
              <th onclick="sortTable('profile_summary')">Profile Summary <i class="bi bi-arrow-down-up sort-icon" id="sort-profile_summary"></i></th>
              <th onclick="sortTable('createdBy')">Created By <i class="bi bi-arrow-down-up sort-icon" id="sort-createdBy"></i></th>
              <th onclick="sortTable('createdAt')">Date <i class="bi bi-arrow-down-up sort-icon" id="sort-createdAt"></i></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="patientTableBody">
            <tr><td colspan="8" class="text-center text-muted py-4">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════ PATIENT PROFILE MODAL ════════════════ -->
<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header d-flex gap-2 flex-wrap">
        <button class="btn btn-outline-secondary btn-sm" onclick="backToPatientList()">
          <i class="bi bi-arrow-left me-1"></i> Back
        </button>
        <button class="btn btn-outline-dark btn-sm" id="copyPatientBtn">
          <i class="bi bi-copy me-1"></i> Copy
        </button>
        <button class="btn btn-dark btn-sm" id="loadPatientBtn">
          <i class="bi bi-box-arrow-in-right me-1"></i> Load
        </button>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="profileModalBody"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/scripts.js' %}"></script>
</body>
</html>